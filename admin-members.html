<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>KAFer - 会員管理</title>
    <link id="favicon" rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="app-container admin-page">
    <header class="app-header">
        <div class="logo"><h1>KAFer Admin</h1></div>
        <div class="user-controls">
            <span class="user-info-header" id="header-user-info"></span>
            <button class="logout-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> ログアウト</button>
        </div>
    </header>
    <div class="main-content-wrapper">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="admin.html"><i class="fas fa-tools"></i> 管理者ダッシュボード</a></li>
                    <li><a href="admin-members.html" class="active"><i class="fas fa-users"></i> 会員管理</a></li>
                    <li><a href="admin-money.html"><i class="fas fa-money-check-alt"></i> KAFerマネー</a></li>
                    <li><a href="admin-settings.html"><i class="fas fa-cogs"></i> サイト設定</a></li>
                    <li><a href="menu.html"><i class="fas fa-arrow-alt-circle-left"></i> ユーザーメニューへ</a></li>
                </ul>
            </nav>
        </aside>
        <main class="container">
            <div id="message-area" class="message"></div>

            <div id="member-management-section" class="content-section">
                <h2><i class="fas fa-users"></i> 会員管理</h2>
                <div class="tab-navigation" id="member-management-tab-nav">
                    <button class="tab-button active" data-target="member-list-tab"><i class="fas fa-user-friends"></i> 会員リスト</button>
                    <button class="tab-button" data-target="admin-register-tab"><i class="fas fa-user-plus"></i> 新規登録</button>
                    <button class="tab-button" data-target="user-modify-tab"><i class="fas fa-user-edit"></i> ユーザー変更</button>
                    <button class="tab-button" data-target="remove-member-tab"><i class="fas fa-user-minus"></i> 会員削除</button>
                </div>
                <div class="tab-content-wrapper">
                    <div id="member-list-tab" class="tab-content">
                        <h3>全会員リスト</h3>
                        <div class="data-table-container">
                            <table class="data-table">
                                <thead>
                                    <tr><th>KAFer ID</th><th>ユーザー名</th><th>登録日</th><th>KAFerマネー残高</th><th>支払い状況</th></tr>
                                </thead>
                                <tbody id="member-list"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="admin-register-tab" class="tab-content" style="display: none;">
                        <h3>新規会員登録</h3>
                        <form id="admin-register-form">
                            <div class="form-group"><label for="admin-register-name"><i class="fas fa-user-circle"></i> ユーザー名 (10文字以下)</label><input type="text" id="admin-register-name" required maxlength="10" title="10文字以下のユーザー名を入力してください"></div>
                            <div class="form-group"><label for="admin-register-kaferId"><i class="fas fa-id-card"></i> KAFer ID (4桁の数字)</label><input type="text" id="admin-register-kaferId" required pattern="[0-9]{4}" title="4桁の数字を入力してください"></div>
                            <div class="form-group"><label for="admin-register-password"><i class="fas fa-key"></i> パスコード (4桁以上の半角英数字記号)</label><input type="password" id="admin-register-password" required pattern="[a-zA-Z0-9!@#$%^&amp;*()_+\-=\\[\\]{}|;:'&lt;&gt;\\./?]{4,}" title="4文字以上の半角英数字記号を入力してください"></div>
                            <button type="submit" class="btn"><i class="fas fa-user-plus"></i> 会員登録</button>
                        </form>
                    </div>
                    <div id="user-modify-tab" class="tab-content" style="display: none;">
                        <h3>ユーザー名変更</h3>
                        <form id="user-modify-form">
                            <div class="form-group"><label for="modify-kaferId"><i class="fas fa-id-card"></i> 変更対象KAFer ID</label><input type="text" id="modify-kaferId" required pattern="[0-9]{4}" title="4桁の数字を入力してください"></div>
                            <div class="form-group"><label for="new-username"><i class="fas fa-user-edit"></i> 新しいユーザー名 (10文字以下)</label><input type="text" id="new-username" required maxlength="10" title="10文字以下のユーザー名を入力してください"></div>
                            <button type="submit" class="btn btn-secondary"><i class="fas fa-save"></i> ユーザー名変更</button>
                        </form>
                    </div>
                    <div id="remove-member-tab" class="tab-content" style="display: none;">
                        <h3>会員削除 (強制退会)</h3>
                        <form id="remove-member-form">
                            <div class="form-group"><label for="remove-kaferId"><i class="fas fa-id-card"></i> 削除対象KAFer ID</label><input type="text" id="remove-kaferId" required pattern="[0-9]{4}" title="4桁の数字を入力してください"></div>
                            <div class="form-group"><label for="remove-reason"><i class="fas fa-comment-alt"></i> 削除理由 (任意)</label><textarea id="remove-reason" rows="3"></textarea></div>
                            <button type="submit" class="btn btn-danger"><i class="fas fa-user-times"></i> 会員を強制削除</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="global.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            initializePwaAndDarkMode();
            await checkLoginStatus(true, true, 'admin-members.html');
            document.body.classList.add('admin-page');

            const user = getLoggedInUser();
            if (!user) return;

            document.getElementById('header-user-info').textContent = `${user.name} (${user.kaferId})`;

            const bottomNavHtml = `
                <nav>
                    <ul>
                        <li><a href="admin.html" data-page="admin.html"><i class="fas fa-tools"></i><span>ダッシュボード</span></a></li>
                        <li><a href="admin-members.html" data-page="admin-members.html"><i class="fas fa-users"></i><span>会員管理</span></a></li>
                        <li><a href="admin-money.html" data-page="admin-money.html"><i class="fas fa-money-check-alt"></i><span>KAFerマネー</span></a></li>
                        <li><a href="admin-settings.html" data-page="admin-settings.html"><i class="fas fa-cogs"></i><span>設定</span></a></li>
                        <li><a href="menu.html"><i class="fas fa-arrow-alt-circle-left"></i><span>メニューへ</span></a></li>
                    </ul>
                </nav>
            `;
            const bottomNavElement = document.createElement('footer');
            bottomNavElement.className = 'bottom-nav';
            bottomNavElement.innerHTML = bottomNavHtml;
            document.body.appendChild(bottomNavElement);

            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.bottom-nav a, .sidebar a').forEach(link => {
                const linkPage = link.getAttribute('href').split('/').pop();
                if (linkPage === currentPage) {
                    link.classList.add('active');
                }
            });

            await loadMembers();
            if (window.location.hash === '#register') {
                showTabContent('member-management-tab-nav', 'admin-register-tab');
            }

            document.querySelectorAll('#member-management-tab-nav .tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetTab = e.currentTarget.dataset.target;
                    showTabContent('member-management-tab-nav', targetTab);
                });
            });

            document.getElementById('admin-register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const name = document.getElementById('admin-register-name').value;
                const kaferId = document.getElementById('admin-register-kaferId').value;
                const password = document.getElementById('admin-register-password').value;
                if (!name || !kaferId || !password) { showMessage('message-area', 'すべてのフィールドを入力してください。', 'error'); return; }
                const records = await fetchSheetData(true);
                const existingUser = records.find(r => r.kaferId === kaferId && r.type === 'register');
                if (existingUser) { showMessage('message-area', 'このKAFer IDは既に登録されています。', 'error'); return; }
                const success = await writeToSheet(name, kaferId, 'register', { pass: password });
                if (success) {
                    showMessage('message-area', `KAFer ID: ${kaferId} を登録しました。`, 'success');
                    document.getElementById('admin-register-form').reset();
                    await loadMembers();
                } else {
                    showMessage('message-area', '会員登録に失敗しました。', 'error');
                }
            });

            document.getElementById('user-modify-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const modifyKaferId = document.getElementById('modify-kaferId').value;
                const newUsername = document.getElementById('new-username').value;
                if (!modifyKaferId || !newUsername) { showMessage('message-area', 'すべてのフィールドを入力してください。', 'error'); return; }
                const records = await fetchSheetData(true);
                const targetUser = records.find(r => r.kaferId === modifyKaferId && r.type === 'register');
                if (!targetUser) { showMessage('message-area', '指定されたKAFer IDの会員は見つかりませんでした。', 'error'); return; }
                if (confirm(`${targetUser.name} のユーザー名を ${newUsername} に変更しますか？`)) {
                    const success = await writeToSheet(user.name, PROJECT_CONFIG.ADMIN_ID, 'name_update', { targetKaferId: modifyKaferId, newName: newUsername });
                    if (success) {
                        showMessage('message-area', `${modifyKaferId} のユーザー名を ${newUsername} に変更しました。`, 'success');
                        document.getElementById('user-modify-form').reset();
                        await loadMembers();
                    } else {
                        showMessage('message-area', 'ユーザー名の変更に失敗しました。', 'error');
                    }
                }
            });

            document.getElementById('remove-member-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const removeKaferId = document.getElementById('remove-kaferId').value;
                const removeReason = document.getElementById('remove-reason').value;
                if (!removeKaferId) { showMessage('message-area', '削除対象のKAFer IDを入力してください。', 'error'); return; }
                const records = await fetchSheetData(true);
                const targetUser = records.find(r => r.kaferId === removeKaferId && r.type === 'register');
                if (!targetUser) { showMessage('message-area', '指定されたKAFer IDの会員は見つかりませんでした。', 'error'); return; }
                if (confirm(`${targetUser.name} (KAFer ID: ${removeKaferId}) を強制削除しますか？`)) {
                    const success = await writeToSheet(user.name, PROJECT_CONFIG.ADMIN_ID, 'remove', { targetKaferId: removeKaferId, reason: removeReason });
                    if (success) {
                        showMessage('message-area', `${removeKaferId} を強制削除しました。`, 'success');
                        document.getElementById('remove-member-form').reset();
                        await loadMembers();
                    } else {
                        showMessage('message-area', '会員の強制削除に失敗しました。', 'error');
                    }
                }
            });
        });

        async function loadMembers() {
            const records = await fetchSheetData(true);
            const memberListBody = document.getElementById('member-list');
            memberListBody.innerHTML = '';
            const allRegisters = records.filter(r => r.type === 'register');
            allRegisters.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            if (allRegisters.length === 0) {
                memberListBody.innerHTML = '<tr><td colspan="5">登録されている会員がいません。</td></tr>';
                return;
            }
            for (const member of allRegisters) {
                const isRemoved = records.some(r => r.type === 'remove' && r.targetKaferId === member.kaferId);
                if (isRemoved) continue;
                const row = memberListBody.insertRow();
                row.insertCell().textContent = member.kaferId;
                row.insertCell().textContent = member.name;
                row.insertCell().textContent = new Date(member.timestamp).toLocaleDateString('ja-JP');
                const kaferMoneyBalance = calculateKAFerMoneyBalance(member.kaferId, records);
                row.insertCell().textContent = `${kaferMoneyBalance}KAFer (${kafToYen(kaferMoneyBalance)}円)`;
                const paymentStatus = await calculateUserPaymentStatus(member.kaferId, records);
                const statusCell = row.insertCell();
                if (paymentStatus.outstanding <= 0) {
                    statusCell.textContent = '支払い済み';
                    statusCell.style.color = 'var(--success-color)';
                } else {
                    statusCell.textContent = `未払い (${paymentStatus.outstanding}KAFer不足)`;
                    statusCell.style.color = 'var(--error-color)';
                }
            }
        }
    </script>
</body>
</html>