<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>KAFer - メニュー</title>
    <link id="favicon" rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.webmanifest">
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body class="app-container menu-page">
    <header class="app-header">
        <div class="logo"><h1>KAFer</h1></div>
        <div class="user-controls">
            <span class="user-info-header" id="header-user-info"></span>
            <button class="logout-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> ログアウト</button>
        </div>
    </header>
    <div class="main-content-wrapper">
        <main class="container">
            <div id="message-area" class="message"></div>

            <div id="dashboard-section" class="content-section">
                <h2><i class="fas fa-user-circle"></i> <span id="dashboard-name"></span>さん</h2>
                <div class="dashboard-metrics">
                    <div class="metric-card"><div class="value" id="dashboard-kafer-money">0 KAFer</div><div class="label">KAFerマネー残高</div></div>
                    <div class="metric-card secondary"><div class="value" id="outstanding-amount-display">0 KAFer</div><div class="label">未払い額</div></div>
                </div>
                <div class="action-buttons" style="flex-direction: column; margin-top: var(--spacing-xxl);">
                    <button class="btn" onclick="showSection('payment-section')"><i class="fas fa-wallet"></i> KAFerマネーを入金する</button>
                    <button class="btn btn-secondary" onclick="showSection('my-payments-section')"><i class="fas fa-history"></i> 利用履歴を確認する</button>
                </div>
            </div>

            <div id="payment-section" class="content-section" style="display: none;">
                <h2><i class="fas fa-wallet"></i> KAFerマネーを入金</h2>
                <div id="reader" style="margin-bottom: var(--spacing-lg);"></div>
                <div class="qr-scanner-controls">
                    <button id="start-scanner-btn" class="btn btn-secondary"><i class="fas fa-camera"></i> QRコードをスキャン</button>
                    <button id="stop-scanner-btn" class="btn btn-danger" style="display: none;"><i class="fas fa-stop-circle"></i> スキャン停止</button>
                </div>
                <form id="payment-form" style="margin-top: var(--spacing-lg);">
                    <div class="form-group"><label for="payment-code"><i class="fas fa-barcode"></i> KAFerマネーコード (16桁)</label><input type="text" id="payment-code" required pattern="[0-9]{16}"></div>
                    <button type="submit" class="btn"><i class="fas fa-check-circle"></i> このコードを使用する</button>
                </form>
            </div>
            
            <div id="my-payments-section" class="content-section" style="display: none;">
                <h2><i class="fas fa-history"></i> 利用履歴</h2>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr><th>日付</th><th>種別</th><th>詳細</th></tr>
                        </thead>
                        <tbody id="my-payments-list"></tbody>
                    </table>
                </div>
            </div>

            <div id="settings-section" class="content-section" style="display: none;">
                <h2><i class="fas fa-cog"></i> 設定</h2>
                <div class="list-group">
                    <div class="list-group-item">
                        <span>パスワード変更</span>
                        <button class="btn btn-sm" onclick="showSection('pass-update-section')"><i class="fas fa-key"></i> 変更する</button>
                    </div>
                    <div class="list-group-item">
                        <span>KAFerマネー返金申請</span>
                        <button class="btn btn-sm" onclick="showSection('refund-request-section')"><i class="fas fa-undo-alt"></i> 申請する</button>
                    </div>
                </div>
            </div>

            <div id="pass-update-section" class="content-section" style="display: none;">
                <h2><i class="fas fa-user-lock"></i> パスワード変更</h2>
                <form id="pass-update-form">
                    <div class="form-group"><label for="current-password"><i class="fas fa-key"></i> 現在のパスワード</label><input type="password" id="current-password" required></div>
                    <div class="form-group"><label for="new-password"><i class="fas fa-unlock-alt"></i> 新しいパスワード</label><input type="password" id="new-password" required></div>
                    <div class="form-group"><label for="confirm-new-password"><i class="fas fa-check-double"></i> 新しいパスワード (確認)</label><input type="password" id="confirm-new-password" required></div>
                    <button type="submit" class="btn btn-secondary"><i class="fas fa-exchange-alt"></i> パスワードを変更</button>
                </form>
            </div>

            <div id="refund-request-section" class="content-section" style="display: none;">
                <h2><i class="fas fa-undo-alt"></i> KAFerマネー返金申請</h2>
                <p>現在の残高: <span id="current-money-balance-refund" style="font-weight: bold;">0 KAFer</span></p>
                <form id="refund-request-form">
                    <div class="form-group"><label for="refund-amount-input"><i class="fas fa-yen-sign"></i> 返金を希望する金額 (100円単位)</label><input type="number" id="refund-amount-input" required min="100" step="100"></div>
                    <p style="font-size: 0.9em; color: var(--medium-grey);">返金には手数料として100円がかかります。</p>
                    <p id="refund-code-display" style="display: none;">返還コード: <span id="generated-refund-code"></span> (このコードを管理者に提示してください)</p>
                    <button type="submit" class="btn btn-danger"><i class="fas fa-paper-plane"></i> 返金申請を提出</button>
                </form>
            </div>
        </main>
    </div>
    <script src="global.js"></script>
    <script>
        let html5QrCode = null;

        document.addEventListener('DOMContentLoaded', async () => {
            initializePwaAndDarkMode();
            await checkLoginStatus(true, false, 'menu.html');
            
            const user = getLoggedInUser();
            if (!user) return;

            document.getElementById('header-user-info').textContent = `${user.name} (${user.kaferId})`;
            document.getElementById('dashboard-name').textContent = user.name;

            const bottomNavHtml = `
                <nav>
                    <ul>
                        <li><a href="#" onclick="showSection('dashboard-section'); return false;" data-section="dashboard-section" class="active"><i class="fas fa-home"></i><span>ホーム</span></a></li>
                        <li><a href="#" onclick="showSection('payment-section'); return false;" data-section="payment-section"><i class="fas fa-wallet"></i><span>入金</span></a></li>
                        <li><a href="#" onclick="showSection('my-payments-section'); return false;" data-section="my-payments-section"><i class="fas fa-history"></i><span>履歴</span></a></li>
                        <li><a href="#" onclick="showSection('settings-section'); return false;" data-section="settings-section"><i class="fas fa-cog"></i><span>設定</span></a></li>
                        ${user.isAdmin ? `<li><a href="admin.html"><i class="fas fa-user-cog"></i><span>管理</span></a></li>` : ''}
                    </ul>
                </nav>
            `;
            const bottomNavElement = document.createElement('footer');
            bottomNavElement.className = 'bottom-nav';
            bottomNavElement.innerHTML = bottomNavHtml;
            document.body.appendChild(bottomNavElement);

            await updateDashboardAndPayments();

            document.getElementById('payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const moneyCode = document.getElementById('payment-code').value;
                if (!moneyCode || !/^[0-9]{16}$/.test(moneyCode)) { showMessage('message-area', '16桁のKAFerマネーコードを入力してください。', 'error'); return; }
                const records = await fetchSheetData();
                const validMoneyCodeRecord = records.find(r => r.type === 'money_code_issue' && r.moneyCode === moneyCode && !records.some(p => p.type === 'payment' && p.paymentCode === moneyCode) && !records.some(v => v.type === 'money_code_void' && v.moneyCode === moneyCode));
                if (!validMoneyCodeRecord) { showMessage('message-area', '無効な、または使用済みのKAFerマネーコードです。', 'error'); return; }
                const success = await writeToSheet(user.name, user.kaferId, 'payment', { paymentCode: moneyCode, amount: validMoneyCodeRecord.amount });
                if (success) {
                    showMessage('message-area', 'KAFerマネーを使用しました。', 'success');
                    document.getElementById('payment-form').reset();
                    await updateDashboardAndPayments();
                    showSection('dashboard-section');
                } else {
                    showMessage('message-area', 'KAFerマネーコードの使用に失敗しました。', 'error');
                }
            });

            document.getElementById('start-scanner-btn').addEventListener('click', startQrScanner);
            document.getElementById('stop-scanner-btn').addEventListener('click', stopQrScanner);
        });

        function showSection(sectionId) {
            document.querySelectorAll('.content-section').forEach(section => section.style.display = 'none');
            document.getElementById(sectionId).style.display = 'block';
            document.querySelectorAll('.bottom-nav a').forEach(link => {
                link.classList.toggle('active', link.dataset.section === sectionId);
            });
            if (html5QrCode && html5QrCode.isScanning) {
                stopQrScanner();
            }
        }

        async function startQrScanner() {
            const startBtn = document.getElementById('start-scanner-btn');
            const stopBtn = document.getElementById('stop-scanner-btn');
            if (window.location.protocol !== 'https:') { showMessage('message-area', 'QRコードスキャナーはHTTPS接続でのみ動作します。', 'error'); return; }
            
            html5QrCode = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            try {
                await html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
                    stopQrScanner();
                    try {
                        const url = new URL(decodedText);
                        const code = url.searchParams.get('code');
                        if (code && /^[0-9]{16}$/.test(code)) {
                            document.getElementById('payment-code').value = code;
                            showMessage('message-area', `QRコードを読み取りました。`, 'success');
                        } else {
                            document.getElementById('payment-code').value = decodedText;
                        }
                    } catch (_) {
                        document.getElementById('payment-code').value = decodedText;
                    }
                });
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
            } catch (err) {
                showMessage('message-area', `QRスキャナーの起動に失敗しました。`, 'error');
            }
        }

        function stopQrScanner() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().then(() => {
                    document.getElementById('start-scanner-btn').style.display = 'block';
                    document.getElementById('stop-scanner-btn').style.display = 'none';
                }).catch(err => console.error(err));
            }
        }

        async function updateDashboardAndPayments() {
            const user = getLoggedInUser();
            if (!user) return;
            const records = await fetchSheetData();
            const kaferMoneyBalance = calculateKAFerMoneyBalance(user.kaferId, records);
            document.getElementById('dashboard-kafer-money').textContent = `${kaferMoneyBalance} KAFer`;
            const paymentStatus = await calculateUserPaymentStatus(user.kaferId, records);
            document.getElementById('outstanding-amount-display').textContent = `${paymentStatus.outstanding} KAFer`;
        }

        function calculateKAFerMoneyBalance(kaferId, allRecords) {
            let balance = 0;
            allRecords.forEach(r => {
                if (r.type === 'payment' && r.kaferId === kaferId) {
                    balance += r.amount || 0;
                } else if (r.type === 'refund_approved' && r.targetKaferId === kaferId) {
                    balance -= r.requestAmountKaf || 0;
                }
            });
            return balance;
        }

        async function calculateUserPaymentStatus(kaferId, allRecords) {
            // Placeholder for payment status logic
            return { outstanding: 0 };
        }
    </script>
</body>
</html>