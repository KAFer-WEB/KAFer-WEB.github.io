<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>KAFer - サイト設定</title>
    <link id="favicon" rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="app-container admin-page">
    <header class="app-header">
        <div class="logo"><h1>KAFer Admin</h1></div>
        <div class="user-controls">
            <span class="user-info-header" id="header-user-info"></span>
            <button class="logout-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> ログアウト</button>
        </div>
    </header>
    <div class="main-content-wrapper">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="admin.html"><i class="fas fa-tools"></i> 管理者ダッシュボード</a></li>
                    <li><a href="admin-members.html"><i class="fas fa-users"></i> 会員管理</a></li>
                    <li><a href="admin-money.html"><i class="fas fa-money-check-alt"></i> KAFerマネー</a></li>
                    <li><a href="admin-settings.html" class="active"><i class="fas fa-cogs"></i> サイト設定</a></li>
                    <li><a href="menu.html"><i class="fas fa-arrow-alt-circle-left"></i> ユーザーメニューへ</a></li>
                </ul>
            </nav>
        </aside>
        <main class="container">
            <div id="message-area" class="message"></div>

            <div id="site-settings-section" class="content-section">
                <h2><i class="fas fa-cogs"></i> サイト設定</h2>
                <div class="tab-navigation" id="settings-tab-nav">
                    <button class="tab-button active" data-target="general-settings-tab"><i class="fas fa-sliders-h"></i> 一般設定</button>
                    <button class="tab-button" data-target="activity-log-tab"><i class="fas fa-history"></i> アクティビティログ</button>
                </div>
                <div class="tab-content-wrapper">
                    <div id="general-settings-tab" class="tab-content">
                        <h3>一般設定</h3>
                        <form id="config-form">
                            <div class="form-group"><label for="admin-email"><i class="fas fa-at"></i> 管理者Eメール (通知用)</label><input type="email" id="admin-email" required></div>
                            <div class="form-group"><label for="admin-panel-password"><i class="fas fa-user-secret"></i> 管理者パスワード (KAFerID '2025')</label><input type="password" id="admin-panel-password" required></div>
                            <div class="form-group"><label for="base-monthly-fee-input"><i class="fas fa-yen-sign"></i> 基本月額会費 (円)</label><input type="number" id="base-monthly-fee-input" required min="0" step="100" value="1000"></div>
                            <button type="submit" class="btn btn-secondary"><i class="fas fa-save"></i> 設定を保存</button>
                        </form>
                        <h3 style="margin-top: var(--spacing-xxl);">緊急情報保護モード</h3>
                        <div class="card">
                            <div class="list-group">
                                <div class="list-group-item"><span>現在のステータス:</span><span id="site-setting-emergency-lockdown-status" style="font-weight: bold; color: var(--success-color);">無効</span></div>
                            </div>
                            <div class="action-buttons" style="margin-top: var(--spacing-lg);">
                                <button class="btn btn-danger" onclick="toggleEmergencyLockdown(true);"><i class="fas fa-lock"></i> 保護モードを有効にする</button>
                                <button class="btn btn-success" onclick="toggleEmergencyLockdown(false);"><i class="fas fa-unlock"></i> 保護モードを無効にする</button>
                            </div>
                            <p style="font-size: 0.85em; color: var(--medium-grey); margin-top: var(--spacing-md);"><i class="fas fa-info-circle"></i> 保護モードを有効にすると、管理者以外の全ユーザーはログインできなくなります。</p>
                        </div>
                    </div>
                    <div id="activity-log-tab" class="tab-content" style="display: none;">
                        <h3>アクティビティログ</h3>
                        <div id="log-entries"><div class="log-entry"><i class="fas fa-info-circle"></i> ログデータがここに表示されます。</div></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="global.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            initializePwaAndDarkMode();
            await checkLoginStatus(true, true, 'admin-settings.html');
            document.body.classList.add('admin-page');

            const user = getLoggedInUser();
            if (!user) return;

            document.getElementById('header-user-info').textContent = `${user.name} (${user.kaferId})`;

            const bottomNavHtml = `
                <nav>
                    <ul>
                        <li><a href="admin.html" data-page="admin.html"><i class="fas fa-tools"></i><span>ダッシュボード</span></a></li>
                        <li><a href="admin-members.html" data-page="admin-members.html"><i class="fas fa-users"></i><span>会員管理</span></a></li>
                        <li><a href="admin-money.html" data-page="admin-money.html"><i class="fas fa-money-check-alt"></i><span>KAFerマネー</span></a></li>
                        <li><a href="admin-settings.html" data-page="admin-settings.html"><i class="fas fa-cogs"></i><span>設定</span></a></li>
                        <li><a href="menu.html"><i class="fas fa-arrow-alt-circle-left"></i><span>メニューへ</span></a></li>
                    </ul>
                </nav>
            `;
            const bottomNavElement = document.createElement('footer');
            bottomNavElement.className = 'bottom-nav';
            bottomNavElement.innerHTML = bottomNavHtml;
            document.body.appendChild(bottomNavElement);

            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.bottom-nav a, .sidebar a').forEach(link => {
                const linkPage = link.getAttribute('href').split('/').pop();
                if (linkPage === currentPage) {
                    link.classList.add('active');
                }
            });

            await loadSiteConfig();
            await loadActivityLogs();

            document.querySelectorAll('#settings-tab-nav .tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    showTabContent('settings-tab-nav', e.currentTarget.dataset.target);
                });
            });

            document.getElementById('config-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const adminEmail = document.getElementById('admin-email').value;
                const adminPanelPassword = document.getElementById('admin-panel-password').value;
                const baseMonthlyFeeYen = parseInt(document.getElementById('base-monthly-fee-input').value, 10);
                if (!adminEmail || !adminPanelPassword) { showMessage('message-area', 'Eメールとパスワードを入力してください。', 'error'); return; }
                
                const configSuccess = await writeToSheet(user.name, PROJECT_CONFIG.ADMIN_ID, 'config', { email: adminEmail, base_monthly_fee_yen: baseMonthlyFeeYen });
                const passUpdateSuccess = await writeToSheet(user.name, PROJECT_CONFIG.ADMIN_ID, 'pass_update', { kaferId: PROJECT_CONFIG.ADMIN_ID, pass: adminPanelPassword });

                if (configSuccess && passUpdateSuccess) {
                    showMessage('message-area', 'サイト設定が保存され、管理者パスワードも更新されました。再ログインしてください。', 'success');
                    setTimeout(logoutUser, 2000);
                } else {
                    showMessage('message-area', 'サイト設定の保存に失敗しました。', 'error');
                }
            });
        });

        async function loadSiteConfig() {
            const records = await fetchSheetData(true);
            const configRecords = records.filter(r => r.type === 'config');
            let currentConfig = { email: '', base_monthly_fee_yen: PROJECT_CONFIG.DEFAULT_SYSTEM_CONFIG.base_monthly_fee_yen };
            if (configRecords.length > 0) {
                const latestConfig = configRecords.reduce((prev, current) => new Date(prev.timestamp) > new Date(current.timestamp) ? prev : current);
                Object.assign(currentConfig, latestConfig);
            }
            document.getElementById('admin-email').value = currentConfig.email;
            document.getElementById('base-monthly-fee-input').value = currentConfig.base_monthly_fee_yen;
            
            const systemConfig = await getSystemConfig(records);
            const statusElement = document.getElementById('site-setting-emergency-lockdown-status');
            if (systemConfig.emergency_lockdown) {
                statusElement.textContent = '有効';
                statusElement.style.color = 'var(--error-color)';
            } else {
                statusElement.textContent = '無効';
                statusElement.style.color = 'var(--success-color)';
            }
        }

        async function loadActivityLogs() {
            const records = await fetchSheetData(true);
            const logEntriesDiv = document.getElementById('log-entries');
            logEntriesDiv.innerHTML = '';
            records.sort((a, b) => new Date(b.TIME).getTime() - new Date(a.TIME).getTime());
            if (records.length === 0) {
                logEntriesDiv.innerHTML = '<div class="log-entry"><i class="fas fa-info-circle"></i> アクティビティログはありません。</div>';
                return;
            }
            records.forEach(record => {
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                let logText = `[${new Date(record.TIME).toLocaleString('ja-JP')}] `;
                let performedBy = record.name ? ` by ${record.name} (${record.kaferId})` : '';
                
                switch(record.type) {
                    case 'register': logText += `新会員登録: ${record.name} (${record.kaferId})`; break;
                    case 'payment': logText += `入金${performedBy}: ${record.amount}KAFer`; break;
                    case 'remove': logText += `会員削除${performedBy}: 対象ID ${record.targetKaferId}`; break;
                    case 'name_update': logText += `ユーザー名変更${performedBy}: 対象ID ${record.targetKaferId} -> ${record.newName}`; break;
                    case 'money_code_issue': logText += `コード発行${performedBy}: ${record.moneyCode}`; break;
                    case 'money_code_void': logText += `コード無効化${performedBy}: ${record.moneyCode}`; break;
                    case 'pass_update': logText += `パスワード変更${performedBy}`; break;
                    case 'config': logText += `サイト設定更新${performedBy}`; break;
                    case 'system_config': logText += `システム設定更新${performedBy}: 緊急モード -> ${record.emergency_lockdown}`; break;
                    case 'announcement': logText += `お知らせ投稿${performedBy}`; break;
                    case 'refund_request': logText += `返金申請${performedBy}: ${record.requestAmountKaf}KAFer`; break;
                    case 'refund_approved': logText += `返金承認${performedBy}: 対象ID ${record.targetKaferId}`; break;
                    default: logText += `未知のアクティビティ: ${record.type}`;
                }
                logEntry.textContent = logText;
                logEntriesDiv.appendChild(logEntry);
            });
        }
    </script>
</body>
</html>