<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>KAFer - ログイン / 新規登録</title>
    <link id="favicon" rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="app-container index-page">
    <header class="app-header">
        <div class="logo"><h1>KAFer</h1></div>
        <div class="user-controls"></div>
    </header>
    <div class="main-content-wrapper">
        <main class="container">
            <div class="content-section">
                <h2><i class="fas fa-lock"></i> ログイン / 新規登録</h2>
                <div id="message-area" class="message"></div>
                <div class="card login-card">
                    <div class="card-header">既存アカウントでログイン</div>
                    <form id="login-form">
                        <div class="form-group">
                            <label for="login-kaferId"><i class="fas fa-id-card"></i> KAFer ID</label>
                            <input type="text" id="login-kaferId" required pattern="[0-9]{4}" title="4桁の数字を入力してください">
                        </div>
                        <div class="form-group">
                            <label for="login-password"><i class="fas fa-key"></i> パスコード</label>
                            <input type="password" id="login-password" required pattern="[a-zA-Z0-9!@#$%^&amp;*()_+\-=\\[\\]{}|;:'&lt;&gt;\\./?]{4,}" title="4文字以上の半角英数字記号を入力してください">
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-sign-in-alt"></i> ログイン</button>
                    </form>
                </div>
                <div class="card register-card" style="margin-top: var(--spacing-xl);">
                    <div class="card-header">新規アカウント登録<button id="toggle-register-form-btn" class="btn btn-secondary" style="float: right; padding: 5px 10px; font-size: 0.9rem;"><i class="fas fa-plus"></i> 開く</button></div>
                    <div id="register-form-wrapper" style="display: none;">
                        <form id="register-form">
                            <div class="form-group">
                                <label for="register-name"><i class="fas fa-user-circle"></i> ユーザー名 (10文字以下)</label>
                                <input type="text" id="register-name" required maxlength="10" title="10文字以下のユーザー名を入力してください">
                            </div>
                            <div class="form-group">
                                <label for="register-kaferId"><i class="fas fa-id-card"></i> KAFer ID (4桁の数字)</label>
                                <input type="text" id="register-kaferId" required pattern="[0-9]{4}" title="4桁の数字を入力してください">
                            </div>
                            <div class="form-group">
                                <label for="register-password"><i class="fas fa-key"></i> パスコード</label>
                                <input type="password" id="register-password" required pattern="[a-zA-Z0-9!@#$%^&amp;*()_+\-=\\[\\]{}|;:'&lt;&gt;\\./?]{4,}" title="4文字以上の半角英数字記号を入力してください">
                            </div>
                            <button type="submit" class="btn btn-secondary"><i class="fas fa-user-plus"></i> アカウント作成</button>
                        </form>
                    </div>
                </div>
                <div style="text-align: center; margin-top: var(--spacing-xxl);">
                    <button id="installAppButton" class="btn btn-secondary" style="display: none;"><i class="fas fa-download"></i> アプリをインストール</button>
                </div>
            </main>
        </div>
    </div>
    <script src="global.js"></script>
    <script>
        let deferredPrompt = null;

        document.addEventListener('DOMContentLoaded', async () => {
            initializePwaAndDarkMode();
            await checkLoginStatus(false, false, 'index.html');
            document.body.classList.add('index-page');

            const installAppButton = document.getElementById('installAppButton');
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallPromptButton();
            });

            installAppButton.addEventListener('click', () => {
                if (!deferredPrompt) return;
                hideInstallPromptButton();
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the A2HS prompt');
                    } else {
                        console.log('User dismissed the A2HS prompt');
                    }
                    deferredPrompt = null;
                });
            });

            const urlParams = new URLSearchParams(window.location.search);
            const initialCode = urlParams.get('code');
            if (initialCode) {
                document.getElementById('login-kaferId').value = initialCode;
            }

            const registerFormWrapper = document.getElementById('register-form-wrapper');
            const toggleRegisterFormBtn = document.getElementById('toggle-register-form-btn');
            toggleRegisterFormBtn.addEventListener('click', () => {
                const isHidden = registerFormWrapper.style.display === 'none' || registerFormWrapper.style.display === '';
                registerFormWrapper.style.display = isHidden ? 'block' : 'none';
                toggleRegisterFormBtn.innerHTML = isHidden ? '<i class="fas fa-minus"></i> 閉じる' : '<i class="fas fa-plus"></i> 開く';
            });

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const kaferId = document.getElementById('login-kaferId').value;
                const password = document.getElementById('login-password').value;
                if (!kaferId || !password) { showMessage('message-area', 'KAFer IDとパスコードを入力してください。', 'error'); return; }
                const loggedInUser = await authenticateUser(kaferId, password);
                if (loggedInUser) {
                    showMessage('message-area', 'ログイン成功！', 'success');
                    window.location.href = loggedInUser.isAdmin ? 'admin.html' : 'menu.html';
                } else {
                    showMessage('message-area', 'KAFer IDまたはパスコードが間違っています。', 'error');
                }
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const name = document.getElementById('register-name').value;
                const kaferId = document.getElementById('register-kaferId').value;
                const password = document.getElementById('register-password').value;
                if (!name || !kaferId || !password) { showMessage('message-area', 'すべてのフィールドを入力してください。', 'error'); return; }
                const records = await fetchSheetData();
                const existingUser = records.find(r => r.kaferId === kaferId && r.type === 'register');
                if (existingUser) { showMessage('message-area', 'このKAFer IDは既に登録されています。', 'error'); return; }
                const success = await writeToSheet(name, kaferId, 'register', { pass: CryptoJS.SHA256(password).toString() });
                if (success) {
                    showMessage('message-area', '新規登録が完了しました！ログインしてください。', 'success');
                    document.getElementById('register-form').reset();
                    registerFormWrapper.style.display = 'none';
                    toggleRegisterFormBtn.innerHTML = '<i class="fas fa-plus"></i> 開く';
                } else {
                    showMessage('message-area', '登録に失敗しました。', 'error');
                }
            });
        });
    </script>
</body>
</html>