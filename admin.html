<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>KAFer - 管理者ダッシュボード</title>
    <link id="favicon" rel="icon" href="icon.png" type="image/png">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="manifest" href="manifest.webmanifest">
</head>
<body class="app-container admin-page">
    <header class="app-header">
        <div class="logo"><h1>KAFer Admin</h1></div>
        <div class="user-controls">
            <span class="user-info-header" id="header-user-info"></span>
            <button class="logout-btn" onclick="logoutUser()"><i class="fas fa-sign-out-alt"></i> ログアウト</button>
        </div>
    </header>
    <div class="main-content-wrapper">
        <aside class="sidebar">
            <nav>
                <ul>
                    <li><a href="admin.html" class="active"><i class="fas fa-tools"></i> 管理者ダッシュボード</a></li>
                    <li><a href="admin-members.html"><i class="fas fa-users"></i> 会員管理</a></li>
                    <li><a href="admin-money.html"><i class="fas fa-money-check-alt"></i> KAFerマネー</a></li>
                    <li><a href="admin-settings.html"><i class="fas fa-cogs"></i> サイト設定</a></li>
                    <li><a href="menu.html"><i class="fas fa-arrow-alt-circle-left"></i> ユーザーメニューへ</a></li>
                </ul>
            </nav>
        </aside>
        <main class="container">
            <div id="message-area" class="message"></div>

            <div id="admin-dashboard-section" class="content-section">
                <h2><i class="fas fa-tools"></i> 管理者ダッシュボード</h2>
                <div class="dashboard-metrics">
                    <div class="metric-card"><div class="value" id="total-members">0</div><div class="label">全会員数</div></div>
                    <div class="metric-card secondary"><div class="value" id="monthly-due">0KAFer</div><div class="label">今月の合計会費徴収額</div></div>
                    <div class="metric-card accent"><div class="value" id="active-money-codes">0</div><div class="label">有効なKAFerマネーコード</div></div>
                </div>
                <h3>クイックアクション</h3>
                <div class="action-buttons">
                    <a href="admin-members.html#register" class="btn btn-secondary"><i class="fas fa-user-plus"></i> 新規会員登録</a>
                    <a href="admin-money.html#issue" class="btn btn-secondary"><i class="fas fa-plus-square"></i> KAFerマネーコード発行</a>
                    <button class="btn btn-danger" onclick="toggleEmergencyLockdown();"><i class="fas fa-shield-alt"></i> 緊急情報保護切り替え</button>
                </div>
                <div class="card" style="margin-top: var(--spacing-xl);">
                    <div class="card-header"><i class="fas fa-exclamation-triangle"></i> システムステータス</div>
                    <div class="list-group">
                        <div class="list-group-item"><span>緊急情報保護モード:</span><span id="emergency-lockdown-status" style="font-weight: bold; color: var(--success-color);">無効</span></div>
                    </div>
                </div>
                <h3 style="margin-top: var(--spacing-xxl);"><i class="fas fa-bullhorn"></i> 運営からのお知らせ投稿</h3>
                <form id="announcement-form">
                    <div class="form-group"><label for="announcement-message"><i class="fas fa-comment-alt"></i> お知らせ内容</label><textarea id="announcement-message" rows="4" required></textarea></div>
                    <button type="submit" class="btn btn-secondary"><i class="fas fa-paper-plane"></i> お知らせを投稿</button>
                </form>
                <h3 style="margin-top: var(--spacing-xxl);"><i class="fas fa-list-alt"></i> 最新のお知らせ履歴</h3>
                <div class="card"><div id="latest-announcements"><div class="log-entry"><i class="fas fa-info-circle"></i> 最新の運営からのお知らせが表示されます。</div></div></div>
            </div>
        </main>
    </div>
    <script src="global.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            initializePwaAndDarkMode();
            await checkLoginStatus(true, true, 'admin.html');
            document.body.classList.add('admin-page');

            const user = getLoggedInUser();
            if (!user) return;

            document.getElementById('header-user-info').textContent = `${user.name} (${user.kaferId})`;

            const bottomNavHtml = `
                <nav>
                    <ul>
                        <li><a href="admin.html" data-page="admin.html"><i class="fas fa-tools"></i><span>ダッシュボード</span></a></li>
                        <li><a href="admin-members.html" data-page="admin-members.html"><i class="fas fa-users"></i><span>会員管理</span></a></li>
                        <li><a href="admin-money.html" data-page="admin-money.html"><i class="fas fa-money-check-alt"></i><span>KAFerマネー</span></a></li>
                        <li><a href="admin-settings.html" data-page="admin-settings.html"><i class="fas fa-cogs"></i><span>設定</span></a></li>
                        <li><a href="menu.html"><i class="fas fa-arrow-alt-circle-left"></i><span>メニューへ</span></a></li>
                    </ul>
                </nav>
            `;
            const bottomNavElement = document.createElement('footer');
            bottomNavElement.className = 'bottom-nav';
            bottomNavElement.innerHTML = bottomNavHtml;
            document.body.appendChild(bottomNavElement);

            const currentPage = window.location.pathname.split('/').pop();
            document.querySelectorAll('.bottom-nav a, .sidebar a').forEach(link => {
                const linkPage = link.getAttribute('href').split('/').pop();
                if (linkPage === currentPage) {
                    link.classList.add('active');
                }
            });

            await updateAdminDashboard();
            await loadLatestAnnouncements();

            document.getElementById('announcement-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                hideMessage('message-area');
                const message = document.getElementById('announcement-message').value;
                if (!message) {
                    showMessage('message-area', 'お知らせ内容を入力してください。', 'error');
                    return;
                }
                const success = await writeToSheet(user.name, PROJECT_CONFIG.ADMIN_ID, 'announcement', { message });
                if (success) {
                    showMessage('message-area', 'お知らせを投稿しました。', 'success');
                    document.getElementById('announcement-form').reset();
                    await loadLatestAnnouncements();
                } else {
                    showMessage('message-area', 'お知らせの投稿に失敗しました。', 'error');
                }
            });
        });

        async function updateAdminDashboard() {
            const records = await fetchSheetData();
            const allRegisters = records.filter(r => r.type === 'register');
            const totalMembers = allRegisters.length;
            document.getElementById('total-members').textContent = totalMembers;

            const currentMonthlyTotalDue = await calculateCurrentMonthlyFee(records);
            document.getElementById('monthly-due').textContent = `${currentMonthlyTotalDue}KAFer (${kafToYen(currentMonthlyTotalDue)}円)`;

            const issuedMoneyCodes = records.filter(r => r.type === 'money_code_issue');
            const activeMoneyCodes = issuedMoneyCodes.filter(code => 
                !records.some(p => p.type === 'payment' && p.paymentCode === code.moneyCode) && 
                !records.some(v => v.type === 'money_code_void' && v.moneyCode === code.moneyCode)
            );
            document.getElementById('active-money-codes').textContent = activeMoneyCodes.length;

            const systemConfig = await getSystemConfig(records);
            const statusElement = document.getElementById('emergency-lockdown-status');
            if (systemConfig.emergency_lockdown) {
                statusElement.textContent = '有効';
                statusElement.style.color = 'var(--error-color)';
            } else {
                statusElement.textContent = '無効';
                statusElement.style.color = 'var(--success-color)';
            }
        }

        async function loadLatestAnnouncements() {
            const records = await fetchSheetData();
            const latestAnnouncementsDiv = document.getElementById('latest-announcements');
            latestAnnouncementsDiv.innerHTML = '';
            const announcements = records.filter(r => r.type === 'announcement');
            announcements.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (announcements.length === 0) {
                latestAnnouncementsDiv.innerHTML = '<div class="log-entry"><i class="fas fa-info-circle"></i> 運営からのお知らせはまだありません。</div>';
                return;
            }
            announcements.slice(0, 5).forEach(announcement => {
                const announcementEntry = document.createElement('div');
                announcementEntry.className = 'log-entry';
                announcementEntry.innerHTML = `<i class="fas fa-bullhorn"></i> [${new Date(announcement.timestamp).toLocaleDateString('ja-JP')}] ${announcement.message}`;
                latestAnnouncementsDiv.appendChild(announcementEntry);
            });
        }

        async function toggleEmergencyLockdown(activate = null) {
            const user = getLoggedInUser();
            if (!user || !user.isAdmin) {
                showMessage('message-area', '管理者権限がありません。', 'error');
                return;
            }
            hideMessage('message-area');
            const records = await fetchSheetData();
            const currentSystemConfig = await getSystemConfig(records);
            const newLockdownStatus = activate !== null ? activate : !currentSystemConfig.emergency_lockdown;
            let confirmationMessage = newLockdownStatus ? '本当に緊急情報保護モードを「有効」にしますか？' : '緊急情報保護モードを「無効」にしますか？';
            if (!confirm(confirmationMessage)) { return; }
            const success = await writeToSheet(user.name, PROJECT_CONFIG.ADMIN_ID, 'system_config', { emergency_lockdown: newLockdownStatus });
            if (success) {
                showMessage('message-area', `緊急情報保護モードを${newLockdownStatus ? '有効' : '無効'}にしました。`, 'success');
                await updateAdminDashboard();
            } else {
                showMessage('message-area', '緊急情報保護モードの切り替えに失敗しました。', 'error');
            }
        }
    </script>
</body>
</html>